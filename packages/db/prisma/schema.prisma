generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String        @id @default(cuid())
  name        String?
  email       String        @unique
  password    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  Credentials Credentials[]
  Workflow    Workflow[]
}

model Triggers {
  id         String            @id @default(cuid())
  name       String
  typeID     String
  config     Json
  workflowId String?           @unique
  type       AvailableTriggers @relation(fields: [typeID], references: [id])
  Workflow   Workflow?         @relation(fields: [workflowId], references: [id])
}

model AvailableTriggers {
  id      String     @id @default(cuid())
  name    String
  type    String     @unique
  config  Json
  Trigger Triggers[]
}

model AvailableNodes {
  id     String  @id @default(cuid())
  name   String
  type   String  @unique
  config Json
  Node   Nodes[]
}

model Nodes {
  id          String         @id @default(cuid())
  name        String
  typeId      String
  config      Json
  position    Int
  workflowId  String?
  Credentials Credentials[]
  type        AvailableNodes @relation(fields: [typeId], references: [id])
  Workflow    Workflow?      @relation(fields: [workflowId], references: [id])
  nodeExe     NodeExecution[]
}

model Credentials {
  id     String  @id
  userId String
  type   String
  config Json
  nodeId String?
  Nodes  Nodes?  @relation(fields: [nodeId], references: [id])
  User   User    @relation(fields: [userId], references: [id])
}

model Workflow {
  id                 String              @id
  name               String
  createdAt          DateTime            @default(now())
  updateAt           DateTime            @default(now())
  description        String
  status             WorkFlowStatus
  userId             String
  config             Json
  Nodes              Nodes[]
  Trigger            Triggers?
  User               User                @relation(fields: [userId], references: [id])
  WorkflowExecutions WorkflowExecution[]
}


model WorkflowExecution {
  id                   String          @id @default(uuid())
  workflowId           String
  Workflow             Workflow        @relation(fields: [workflowId], references: [id])
  status               WorkFlowStatus
  startAt              DateTime        @default(now())  
  completedAt          DateTime?
  error                String?
  NodeExecutions       NodeExecution[]
}

model NodeExecution{
  id                  String              @id @default(uuid())
  workflowExeId       String
  nodeId              String
  status              WorkFlowStatus
  startedAt           DateTime            @default(now())  
  completedAt         DateTime?
  inputData           Json?
  outputData          Json?
  error               String?
  retries             Int                 @default(0)
  WorkflowExecution   WorkflowExecution   @relation(fields: [workflowExeId], references: [id])
  nodes               Nodes               @relation(fields: [nodeId], references: [id])
}
enum WorkFlowStatus {
  Start
  Pending
  InProgress
  ReConnecting
  Failed
  Completed
}
