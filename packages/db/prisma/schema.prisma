generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ------------------------
 * USER & CREDENTIALS
 * ------------------------
 */

model User {
  id        String   @id @default(uuid())
  // id String @id @default(uuid()) @db.Uuid
  name      String?
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  credentials Credential[]
  workflows   Workflow[]
}

model Credential {
  id     String  @id @default(uuid())
  userId String
  type   String
  config Json
  nodeId String?

  node Node? @relation(fields: [nodeId], references: [id])
  user User  @relation(fields: [userId], references: [id])
}

/**
 * ------------------------
 * TRIGGERS
 * ------------------------
 */

model Trigger {
  id                 String  @id @default(uuid())
  name               String
  AvailableTriggerID String
  config             Json
  workflowId         String? @unique

  triggerType AvailableTrigger @relation(fields: [AvailableTriggerID], references: [id])
  workflow    Workflow?        @relation(fields: [workflowId], references: [id])
}

model AvailableTrigger {
  id     String @id @default(uuid())
  name   String
  type   String @unique
  config Json

  triggers Trigger[]
}

/**
 * ------------------------
 * NODES
 * ------------------------
 */

model AvailableNode {
  id          String   @id @default(uuid())
  name        String
  type        String   @unique
  config      Json
  authType    String?
  requireAuth Boolean?
  description String?
  nodes       Node[]
}

model Node {
  id             String  @id @default(uuid())
  name           String
  AvailabeNodeID String
  config         Json
  position       Int
  workflowId     String?

  AvailabeNodeId AvailableNode   @relation(fields: [AvailabeNodeID], references: [id])
  workflow       Workflow?       @relation(fields: [workflowId], references: [id])
  credentials    Credential[]
  executions     NodeExecution[]
}

/**
 * ------------------------
 * WORKFLOW
 * ------------------------
 */

model Workflow {
  id          String          @id @default(uuid())
  name        String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  description String
  status      WorkflowStatus?
  userId      String
  config      Json

  nodes      Node[]
  Trigger    Trigger?
  user       User                @relation(fields: [userId], references: [id])
  executions WorkflowExecution[]
}

/**
 * ------------------------
 * WORKFLOW EXECUTION
 * ------------------------
 */

model WorkflowExecution {
  id          String         @id @default(uuid())
  workflowId  String
  status      WorkflowStatus
  startAt     DateTime       @default(now())
  completedAt DateTime?
  error       String?
  metadata    Json

  workflow       Workflow                @relation(fields: [workflowId], references: [id])
  executionTable WorkflowExecutionTable?
  nodeExecutions NodeExecution[]
}

/**
 * ------------------------
 * NODE EXECUTION
 * ------------------------
 */

model NodeExecution {
  id             String         @id @default(uuid())
  workflowExecId String
  nodeId         String
  status         WorkflowStatus
  startedAt      DateTime       @default(now())
  completedAt    DateTime?
  inputData      Json?
  outputData     Json?
  error          String?
  retries        Int            @default(0)

  workflowExecution WorkflowExecution @relation(fields: [workflowExecId], references: [id])
  node              Node              @relation(fields: [nodeId], references: [id])
}

/**
 * ------------------------
 * WORKFLOW EXEC TABLE
 * ------------------------
 */

model WorkflowExecutionTable {
  id                  String @id @default(uuid())
  workflowExecutionId String @unique

  workflowExecution WorkflowExecution @relation(fields: [workflowExecutionId], references: [id])
}

/**
 * ------------------------
 * ENUMS
 * ------------------------
 */

enum WorkflowStatus {
  Start
  Pending
  InProgress
  ReConnecting
  Failed
  Completed
}
