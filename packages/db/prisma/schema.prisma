generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  name        String?
  email       String       @unique
  password    String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  credentials Credential[]
  workflows   Workflow[]
}

model Credential {
  id     String  @id @default(uuid())
  userId String
  type   String
  config Json
  nodeId String?
  node   Node?   @relation(fields: [nodeId], references: [id])
  user   User    @relation(fields: [userId], references: [id])
}

model Trigger {
  id                 String           @id @default(uuid())
  name               String
  config             Json
  workflowId         String?          @unique
  AvailableTriggerID String
  triggerType        AvailableTrigger @relation(fields: [AvailableTriggerID], references: [id])
  workflow           Workflow?        @relation(fields: [workflowId], references: [id])
}

model AvailableTrigger {
  id       String    @id @default(uuid())
  name     String
  type     String    @unique
  config   Json
  triggers Trigger[]
}

model AvailableNode {
  id          String   @id @default(uuid())
  name        String
  type        String   @unique
  config      Json
  authType    String?
  requireAuth Boolean?
  description String?
  nodes       Node[]
}

model Node {
  id             String          @id @default(uuid())
  name           String
  config         Json
  position       Int
  workflowId     String?
  AvailabeNodeID String
  credentials    Credential[]
  AvailabeNodeId AvailableNode   @relation(fields: [AvailabeNodeID], references: [id])
  workflow       Workflow?       @relation(fields: [workflowId], references: [id])
  executions     NodeExecution[]
}

model Workflow {
  id          String              @id @default(uuid())
  name        String
  createdAt   DateTime            @default(now())
  description String
  userId      String
  config      Json
  updatedAt   DateTime            @updatedAt
  status      WorkflowStatus?
  nodes       Node[]
  Trigger     Trigger?
  user        User                @relation(fields: [userId], references: [id])
  executions  WorkflowExecution[]
}

model WorkflowExecution {
  id             String                  @id @default(uuid())
  workflowId     String
  startAt        DateTime                @default(now())
  completedAt    DateTime?
  error          String?
  metadata       Json
  status         WorkflowStatus
  nodeExecutions NodeExecution[]
  workflow       Workflow                @relation(fields: [workflowId], references: [id])
  executionTable WorkflowExecutionTable?
}

model NodeExecution {
  id                String            @id @default(uuid())
  nodeId            String
  startedAt         DateTime          @default(now())
  completedAt       DateTime?
  inputData         Json?
  outputData        Json?
  error             String?
  retries           Int               @default(0)
  workflowExecId    String
  status            WorkflowStatus
  node              Node              @relation(fields: [nodeId], references: [id])
  workflowExecution WorkflowExecution @relation(fields: [workflowExecId], references: [id])
}

model WorkflowExecutionTable {
  id                  String            @id @default(uuid())
  workflowExecutionId String            @unique
  workflowExecution   WorkflowExecution @relation(fields: [workflowExecutionId], references: [id])
}

enum WorkflowStatus {
  Start
  Pending
  InProgress
  ReConnecting
  Failed
  Completed
}
