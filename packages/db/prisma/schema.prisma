generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  name        String?
  email       String       @unique
  password    String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  credentials Credential[]
  workflows   Workflow[]
}

model Credential {
  id                                  String    @id @default(uuid())
  userId                              String
  type                                String
  config                              Json
  nodeId                              String?
  node                                Node?     @relation(fields: [nodeId], references: [id])
  user                                User      @relation(fields: [userId], references: [id])
  Node_Node_CredentialsIDToCredential Node[]    @relation("Node_CredentialsIDToCredential")
  Trigger                             Trigger[]
}

model Trigger {
  id                 String           @id @default(uuid())
  name               String
  config             Json
  workflowId         String?          @unique
  AvailableTriggerID String
  CredentialsID      String?
  triggerType        AvailableTrigger @relation(fields: [AvailableTriggerID], references: [id])
  Credential         Credential?      @relation(fields: [CredentialsID], references: [id])
  workflow           Workflow?        @relation(fields: [workflowId], references: [id])
}

model AvailableTrigger {
  id       String    @id @default(uuid())
  name     String
  type     String    @unique
  config   Json
  triggers Trigger[]
}

model AvailableNode {
  id          String   @id @default(uuid())
  name        String
  type        String   @unique
  config      Json
  authType    String?
  requireAuth Boolean?
  description String?
  Node        Node[]
}

model Node {
  id                                        String          @id @default(uuid())
  name                                      String
  config                                    Json
  stage                                     Int
  workflowId                                String?
  AvailableNodeID                           String
  CredentialsID                             String?
  position                                  Json?
  credentials                               Credential[]
  AvailableNode                             AvailableNode   @relation(fields: [AvailableNodeID], references: [id])
  Credential_Node_CredentialsIDToCredential Credential?     @relation("Node_CredentialsIDToCredential", fields: [CredentialsID], references: [id])
  workflow                                  Workflow?       @relation(fields: [workflowId], references: [id])
  executions                                NodeExecution[]
}

model Workflow {
  id          String              @id @default(uuid())
  name        String
  createdAt   DateTime            @default(now())
  description String
  userId      String
  config      Json
  updatedAt   DateTime            @updatedAt
  status      WorkflowStatus?
  isEmpty     Boolean?            @default(true)
  Edges       Json?
  nodes       Node[]
  Trigger     Trigger?
  user        User                @relation(fields: [userId], references: [id])
  executions  WorkflowExecution[]
}

model WorkflowExecution {
  id             String                  @id @default(uuid())
  workflowId     String
  startAt        DateTime                @default(now())
  completedAt    DateTime?
  error          String?
  metadata       Json
  status         WorkflowStatus
  nodeExecutions NodeExecution[]
  workflow       Workflow                @relation(fields: [workflowId], references: [id])
  executionTable WorkflowExecutionTable?
}

model NodeExecution {
  id                String            @id @default(uuid())
  nodeId            String
  startedAt         DateTime          @default(dbgenerated("(now() AT TIME ZONE 'utc'::text)")) @db.Timestamptz(6)
  completedAt       DateTime?         @default(dbgenerated("(now() AT TIME ZONE 'utc'::text)")) @db.Timestamptz(6)
  inputData         Json?
  outputData        Json?
  error             String?
  retries           Int               @default(0)
  workflowExecId    String
  status            WorkflowStatus
  node              Node              @relation(fields: [nodeId], references: [id])
  workflowExecution WorkflowExecution @relation(fields: [workflowExecId], references: [id])
}

model WorkflowExecutionTable {
  id                  String            @id @default(uuid())
  workflowExecutionId String            @unique
  sent                Boolean           @default(false)
  workflowExecution   WorkflowExecution @relation(fields: [workflowExecutionId], references: [id])
}

enum WorkflowStatus {
  Start
  Pending
  InProgress
  ReConnecting
  Failed
  Completed
}
